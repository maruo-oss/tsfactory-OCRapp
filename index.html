<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-OCR ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <style>
    /* --- CSS Styles --- */
    * { box-sizing: border-box; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: "Helvetica Neue", Arial, sans-serif; color: #333; font-size: 14px; background-color: #f4f6f8; }

    .app-container { display: flex; flex-direction: column; height: 100vh; }
    
    /* Header */
    .app-header { height: 56px; background: #fff; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #ddd; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
    .app-header h1 { font-size: 18px; margin: 0; color: #1a73e8; font-weight: bold; }
    .header-actions { display: flex; gap: 15px; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 5px; font-size: 13px; }
    .filter-group select { padding: 4px; border-radius: 4px; border: 1px solid #ccc; }

    /* Buttons */
    button { cursor: pointer; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: #1a73e8; color: white; }
    .btn-primary:hover { background: #1557b0; }
    .btn-secondary { background: #fff; border: 1px solid #ccc; color: #555; }
    .btn-secondary:hover { background: #f1f3f4; }
    .btn-edit { background: #fff; border: 1px solid #1a73e8; color: #1a73e8; }
    .btn-edit:hover { background: #e8f0fe; }
    .btn-save { background: #188038; color: white; }
    .btn-save:hover { background: #13652b; }

    /* Main Layout */
    .main-content { display: flex; flex: 1; overflow: hidden; }
    
    /* Sidebar (File List) */
    .sidebar-list { width: 320px; border-right: 1px solid #ddd; background: #fff; display: flex; flex-direction: column; }
    .sidebar-header { padding: 12px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
    .list-container { flex: 1; overflow-y: auto; }
    
    .file-item { padding: 12px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: flex-start; transition: background 0.1s; }
    .file-item:hover { background: #f8f9fa; }
    .file-item.active { background: #e8f0fe; border-left: 4px solid #1a73e8; }
    .file-checkbox { transform: scale(1.2); margin-top: 4px; margin-right: 12px; cursor: pointer; }
    .file-info { flex: 1; min-width: 0; }
    .file-shop { font-weight: bold; font-size: 14px; margin-bottom: 4px; color: #202124; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-sub { font-size: 12px; color: #666; display: flex; justify-content: space-between; }
    
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; background: #666; margin-right: 6px; vertical-align: text-bottom; }
    .badge[data-branch="æ±äº¬"] { background: #1a73e8; }
    .badge[data-branch="å¤§é˜ª"] { background: #d93025; }

    /* Editor Pane (Middle) */
    .editor-pane { flex: 1; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; background: #fff; display: flex; flex-direction: column; min-width: 400px; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f3f4; padding-bottom: 15px; margin-bottom: 20px; }
    .editor-header h2 { margin: 0; font-size: 18px; color: #202124; }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .info-item label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; font-weight: bold; }
    
    /* Inputs */
    .form-input { width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; background: #fff; font-size: 14px; transition: 0.2s; }
    .form-input:focus { border-color: #1a73e8; outline: none; }
    .form-input.readonly { background: transparent; border: 1px solid transparent; padding: 0; font-weight: bold; color: #202124; pointer-events: none; }
    
    .detail-input { width: 100%; padding: 6px; border: 1px solid #dadce0; border-radius: 4px; font-size: 13px; }
    .detail-input:focus { border-color: #1a73e8; outline: none; background: #fff; }
    .detail-input.readonly { background: transparent; border: none; padding: 6px 0; color: #333; pointer-events: none; }
    .detail-input.changed { background-color: #fff3cd; border-color: #f1c40f; }

    /* Table */
    .table-wrapper { flex: 1; overflow: auto; border: 1px solid #e0e0e0; border-radius: 8px; }
    .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 500px; }
    .detail-table th { position: sticky; top: 0; background: #f1f3f4; padding: 10px 12px; text-align: left; font-weight: bold; color: #5f6368; border-bottom: 1px solid #e0e0e0; z-index: 2; }
    .detail-table td { padding: 8px 12px; border-bottom: 1px solid #f1f1f1; vertical-align: middle; }
    .detail-table tr:hover { background-color: #f8f9fa; }
    .num { text-align: right; }
    
    /* Preview Pane (Right) */
    .preview-pane { width: 35%; background: #202124; display: flex; flex-direction: column; border-left: 1px solid #ddd; }
    .preview-header { padding: 10px; background: #3c4043; color: #fff; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
    .preview-content { flex: 1; position: relative; background: #5f6368; display: flex; justify-content: center; align-items: center; }
    
    iframe { border: none; width: 100%; height: 100%; display: block; }
    
    /* Utilities */
    .empty-state { text-align: center; color: #9aa0a6; padding: 40px; }
    .loading { text-align: center; padding: 20px; color: #666; font-style: italic; }
    .hidden { display: none !important; }

    /* Select and Textarea readonly styles */
    select.form-input.readonly {
      background: transparent;
      border: 1px solid transparent;
      font-weight: bold;
      pointer-events: none;
      appearance: none;
    }

    textarea.form-input {
      font-family: inherit;
      line-height: 1.4;
    }

    textarea.form-input.readonly {
      background: transparent;
      border: 1px solid transparent;
      padding: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="app-container">
    <header class="app-header">
      <h1>AI-OCR ç™ºæ³¨ç®¡ç†</h1>
      <div class="header-actions">
        <div class="filter-group">
          <button onclick="triggerManualProcess()" class="btn-secondary" id="refreshBtn" title="Google Driveã‚’ç¢ºèªã—ã¦æ–°è¦å‡¦ç†">
            <span>â†»</span> è‡ªå‹•å–è¾¼å®Ÿè¡Œ
          </button>
        </div>
        <div class="filter-group" style="margin-left: 10px;">
          <label>è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿:</label>
          <select id="branchSelect" onchange="filterList()">
            <option value="all">å…¨æ‹ ç‚¹</option>
            <option value="æ±äº¬">æ±äº¬</option>
            <option value="å¤§é˜ª">å¤§é˜ª</option>
          </select>
        </div>
      </div>
      <button onclick="exportSelectedFiles()" class="btn-primary" title="ãƒã‚§ãƒƒã‚¯ã—ãŸç™ºæ³¨æ›¸ã‚’ã¾ã¨ã‚ã¦Excelå‡ºåŠ›">
        <span>ğŸ“¥</span> é¸æŠã—ãŸåº—èˆ—ã‚’Excelå‡ºåŠ›
      </button>
      <button onclick="archiveSelectedFiles()" class="btn-secondary" title="ãƒã‚§ãƒƒã‚¯ã—ãŸç™ºæ³¨æ›¸ã‚’å®Œäº†ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰">
        <span>âœ“</span> é¸æŠã—ãŸç™ºæ³¨æ›¸ã‚’å®Œäº†ã«ã™ã‚‹
      </button>
    </header>

    <div class="main-content">
      <aside class="sidebar-list">
        <div class="sidebar-header">
          <span>ç™ºæ³¨æ›¸ä¸€è¦§</span>
          <label style="cursor:pointer; font-size:12px; display:flex; align-items:center;">
            <input type="checkbox" id="selectAllFiles" onclick="toggleAllFiles(this)"> å…¨é¸æŠ
          </label>
        </div>
        <div id="fileList" class="list-container">
          <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
        </div>
      </aside>

      <main class="editor-pane">
        <div class="editor-header">
          <h2>ç™ºæ³¨è©³ç´°</h2>
          <div class="editor-actions">
            <button id="editBtn" onclick="toggleEditMode()" class="btn-edit" style="display:none;">âœ ç·¨é›†</button>
            <button id="saveBtn" onclick="saveChanges()" class="btn-save hidden">ğŸ’¾ ä¿å­˜</button>
            <button id="cancelBtn" onclick="cancelEditMode()" class="btn-secondary hidden">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <label>æ‹ ç‚¹</label>
            <input type="text" id="viewBranch" readonly class="form-input readonly">
          </div>
          <div class="info-item">
            <label>åº—èˆ—å</label>
            <input type="text" id="viewShop" readonly class="form-input readonly">
          </div>
          <div class="info-item">
            <label>ç´å“å…ˆï¼ˆæ ªå¼ä¼šç¤¾/æœ‰é™ä¼šç¤¾ãªã©ï¼‰</label>
            <input type="text" id="viewDest" readonly class="form-input readonly">
          </div>
          <div class="info-item">
            <label>ãƒ¡ãƒ¼ã‚«ãƒ¼</label>
            <input type="text" id="viewMaker" readonly class="form-input readonly">
          </div>
          <div class="info-item">
            <label>ç™ºæ³¨æ—¥</label>
            <input type="date" id="viewDate" readonly class="form-input readonly">
          </div>
          <div class="info-item">
            <label>ç™ºæ³¨No</label>
            <input type="text" id="viewOrderNumber" class="form-input readonly" readonly>
          </div>
          <div class="info-item">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="viewStatus" class="form-input readonly" disabled>
              <option value="æœªå‡¦ç†">æœªå‡¦ç†</option>
              <option value="å‡¦ç†ä¸­">å‡¦ç†ä¸­</option>
              <option value="ç¢ºèªä¸­">ç¢ºèªä¸­</option>
              <option value="å®Œäº†">å®Œäº†</option>
              <option value="ä¿ç•™">ä¿ç•™</option>
              <option value="è¦ç¢ºèª">è¦ç¢ºèª</option>
            </select>
          </div>
          <div class="info-item" style="grid-column: 1 / -1;">
            <label>ãƒ•ã‚¡ã‚¤ãƒ«å</label>
            <input type="text" id="viewFileName" class="form-input readonly" readonly>
          </div>
          <div class="info-item" style="grid-column: 1 / -1;">
            <label>å‚™è€ƒ</label>
            <textarea id="viewComment" class="form-input readonly" rows="2" maxlength="500" style="resize:vertical;" readonly></textarea>
          </div>
        </div>

        <h3>å•†å“æ˜ç´°</h3>
        <div class="table-wrapper">
          <table class="detail-table">
            <thead>
              <tr>
                <th width="15%">å“ç•ª</th>
                <th>å•†å“å</th>
                <th class="num" width="12%">å˜ä¾¡</th>
                <th class="num" width="10%">æ•°é‡</th>
                <th class="num" width="15%">å°è¨ˆ</th>
              </tr>
            </thead>
            <tbody id="detailTableBody">
              <tr><td colspan="5" class="empty-state">å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ç™ºæ³¨æ›¸ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
            </tbody>
          </table>
        </div>
      </main>

      <aside class="preview-pane">
        <div class="preview-header">
          <span>åŸæœ¬PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
          <a href="#" id="pdfLink" target="_blank" style="color:#8ab4f8; text-decoration:none; font-size:11px; display:none;">åˆ¥ã‚¿ãƒ–ã§é–‹ã â†—</a>
        </div>
        <div id="pdfContainer" class="preview-content">
          <div style="color:#aaa;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
        </div>
      </aside>
    </div>
  </div>

<script>
  // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
  let rawData = [];
  let groupedFiles = [];
  let currentFileGroup = null;

  // --- åˆæœŸåŒ– ---
  document.addEventListener('DOMContentLoaded', () => {
    console.log("[CLIENT] ã‚¢ãƒ—ãƒªèµ·å‹•");
    loadData();
  });

  // --- 1. ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æ•´å½¢ ---
  function loadData() {
    const listEl = document.getElementById('fileList');
    listEl.innerHTML = '<div class="loading">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>';
    
    document.getElementById('editBtn').style.display = 'none';
    hideEditControls();

    google.script.run
      .withSuccessHandler(onDataLoaded)
      .withFailureHandler(e => {
        alert('ã€èª­è¾¼ã‚¨ãƒ©ãƒ¼ã€‘\n' + e.message);
        listEl.innerHTML = `<div style="color:#d93025; padding:20px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:<br>${e.message}</div>`;
      })
      .getDataFromSpreadsheet();
  }

  function onDataLoaded(data) {
    console.log(`[CLIENT] å—ä¿¡ä»¶æ•°: ${data ? data.length : 0}ä»¶`);
    
    if (!data || data.length === 0) {
      document.getElementById('fileList').innerHTML = '<div class="empty-state">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    rawData = data;
    
    try {
      const groups = {};
      rawData.forEach(item => {
        const key = item.fileId ? item.fileId : (item.fileName + item.branch);
        
        if (!groups[key]) {
          groups[key] = {
            groupKey: key,
            fileId: item.fileId,
            fileName: item.fileName,
            branch: item.branch,
            shop: item.shop,
            dest: item.dest,
            maker: item.maker,
            date: item.date,
            order_number: item.order_number || '',
            status: item.status || 'æœªå‡¦ç†',
            comment: item.comment || '',
            items: []
          };
        }
        groups[key].items.push(item);
      });

      // å„ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§item_orderã§ã‚½ãƒ¼ãƒˆ
      Object.values(groups).forEach(group => {
        group.items.sort((a, b) => {
          const orderA = a.item_order || 0;
          const orderB = b.item_order || 0;
          return orderA - orderB;
        });
      });

      groupedFiles = Object.values(groups);
      filterList();
      
      if (currentFileGroup) {
        const sameFile = groupedFiles.find(g => g.groupKey === currentFileGroup.groupKey);
        if (sameFile) {
          selectFile(sameFile, null);
        } else {
          document.getElementById('detailTableBody').innerHTML = '<tr><td colspan="5" class="empty-state">é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
          currentFileGroup = null;
        }
      }

    } catch (err) {
      console.error(err);
      alert("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼: " + err.message);
    }
  }

  // --- 2. ãƒªã‚¹ãƒˆè¡¨ç¤º ---
  function renderFileList(files) {
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    
    if (!files.length) { 
      list.innerHTML = '<div class="empty-state">è©²å½“ãªã—</div>'; 
      return; 
    }

    files.forEach(file => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.dataset.key = file.groupKey;
      
      if (currentFileGroup && (currentFileGroup.groupKey === file.groupKey)) {
        div.classList.add('active');
      }
      
      div.onclick = (e) => {
        if (e.target.type === 'checkbox') return;
        selectFile(file, div);
      };
      
      div.innerHTML = `
        <input type="checkbox" class="file-checkbox" value="${file.fileId || ''}">
        <div class="file-info">
          <div class="file-shop">
            <span class="badge" data-branch="${file.branch}">${file.branch || 'æœªè¨­å®š'}</span>
            ${file.fileName || '(ãƒ•ã‚¡ã‚¤ãƒ«åä¸æ˜)'}
            ${file.status && file.status !== 'æœªå‡¦ç†' ? `<span class="badge" style="background:#f57c00; margin-left:4px;">${file.status}</span>` : ''}
          </div>
          <div class="file-sub">
            <span>${file.date || '-'}</span>
            <span>${file.items.length}æ˜ç´°</span>
          </div>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function filterList() {
    const branch = document.getElementById('branchSelect').value;
    const filtered = (branch === 'all') ? groupedFiles : groupedFiles.filter(f => f.branch === branch);
    renderFileList(filtered);
  }

  // --- 3. è©³ç´°è¡¨ç¤º ---
  function selectFile(fileGroup, el) {
    try {
        if (el) {
          document.querySelectorAll('.file-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
        } else {
          const target = document.querySelector(`.file-item[data-key="${fileGroup.groupKey}"]`);
          if (target) {
            document.querySelectorAll('.file-item').forEach(e => e.classList.remove('active'));
            target.classList.add('active');
          }
        }

        currentFileGroup = fileGroup;
        hideEditControls(); 

        document.getElementById('editBtn').style.display = 'inline-block';

        const setText = (id, val) => {
          const elem = document.getElementById(id);
          if (elem) elem.value = val || '';
        };

        setText('viewBranch', fileGroup.branch);
        setText('viewShop', fileGroup.shop);
        setText('viewDest', fileGroup.dest);
        setText('viewMaker', fileGroup.maker);
        
        const dateEl = document.getElementById('viewDate');
        let dateVal = fileGroup.date || '';
        dateVal = dateVal.replace(/\//g, '-');
        
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateVal)) {
            dateEl.value = dateVal;
        } else {
            dateEl.value = "";
        }

        // ç™ºæ³¨ç•ªå·ã®è¨­å®š
        setText('viewOrderNumber', fileGroup.order_number || '');

        // ãƒ•ã‚¡ã‚¤ãƒ«åã®è¨­å®š
        setText('viewFileName', fileGroup.fileName || '');

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»å‚™è€ƒã®è¨­å®š
        document.getElementById('viewStatus').value = fileGroup.status || 'æœªå‡¦ç†';
        document.getElementById('viewComment').value = fileGroup.comment || '';

        const tbody = document.getElementById('detailTableBody');
        tbody.innerHTML = '';
        
        if (!fileGroup.items || fileGroup.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        } else {
           fileGroup.items.forEach(item => {
              const tr = document.createElement('tr');
              tr.dataset.key = item.uniqueKey;
              
              const price = Number(item.price) || 0;
              const qty = Number(item.qty) || 0;
              const total = Number(item.total) || (price * qty);

              tr.innerHTML = `
                <td><input type="text" class="detail-input readonly" value="${item.p_code || ''}" readonly></td>
                <td><input type="text" class="detail-input readonly" value="${item.p_name || ''}" readonly></td>
                <td class="num">
                  <input type="number" class="detail-input readonly num-input price" value="${price}" readonly oninput="updateSubtotal(this)">
                </td>
                <td class="num">
                  <input type="number" class="detail-input readonly num-input qty" value="${qty}" readonly oninput="updateSubtotal(this)">
                </td>
                <td class="num subtotal" style="font-weight:bold;">${total.toLocaleString()}</td>
              `;
              tbody.appendChild(tr);
           });
        }

        updatePdfPreview(fileGroup.fileId);
        
    } catch(e) {
        console.error(e);
        alert("è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: " + e.message);
    }
  }

  function updatePdfPreview(fileId) {
    const container = document.getElementById('pdfContainer');
    const link = document.getElementById('pdfLink');
    
    if (fileId && fileId.length > 5 && fileId !== 'unknown') {
      const previewUrl = `https://drive.google.com/file/d/${fileId}/preview`;
      container.innerHTML = `<iframe src="${previewUrl}" allow="autoplay"></iframe>`;
      link.href = previewUrl;
      link.style.display = 'inline';
    } else {
      container.innerHTML = `<div style="color:#aaa; text-align:center;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯</div>`;
      link.style.display = 'none';
    }
  }

  // --- 4. ç·¨é›†æ©Ÿèƒ½ ---
  function toggleEditMode() {
    if (!currentFileGroup) return;
    
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('saveBtn').classList.remove('hidden');
    document.getElementById('cancelBtn').classList.remove('hidden');

    document.querySelectorAll('.form-input, .detail-input').forEach(input => {
      if (input.id === 'viewBranch') return;

      input.readOnly = false;
      input.disabled = false;  // selectç”¨ã«è¿½åŠ 
      input.classList.remove('readonly');

      input.addEventListener('change', function() {
        this.classList.add('changed');
      });
    });
  }

  function cancelEditMode() {
    hideEditControls();
    if (currentFileGroup) {
      selectFile(currentFileGroup, null);
    }
  }
  
  function hideEditControls() {
    document.getElementById('editBtn').style.display = 'inline-block';
    document.getElementById('saveBtn').classList.add('hidden');
    document.getElementById('cancelBtn').classList.add('hidden');
    
    document.querySelectorAll('.form-input, .detail-input').forEach(input => {
      input.readOnly = true;
      input.classList.add('readonly');
      input.classList.remove('changed');
    });
  }

  function updateSubtotal(input) {
    const tr = input.closest('tr');
    const price = parseFloat(tr.querySelector('.price').value) || 0;
    const qty = parseFloat(tr.querySelector('.qty').value) || 0;
    const subtotalEl = tr.querySelector('.subtotal');
    
    const newTotal = price * qty;
    subtotalEl.innerText = newTotal.toLocaleString();
    input.classList.add('changed');
  }

  // --- 5. ä¿å­˜æ©Ÿèƒ½ ---
  function saveChanges() {
    if (!confirm('å¤‰æ›´å†…å®¹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

    const updates = [];
    const shop = document.getElementById('viewShop').value;
    const dest = document.getElementById('viewDest').value;
    const maker = document.getElementById('viewMaker').value;
    const date = document.getElementById('viewDate').value;
    const orderNum = document.getElementById('viewOrderNumber').value;
    const status = document.getElementById('viewStatus').value;
    const comment = document.getElementById('viewComment').value;

    const rows = document.querySelectorAll('#detailTableBody tr');
    rows.forEach(tr => {
      const key = tr.dataset.key;
      const inputs = tr.querySelectorAll('input');

      updates.push({
        uniqueKey: key,
        shop: shop,
        dest: dest,
        maker: maker,
        date: date,
        orderNum: orderNum,
        status: status,
        comment: comment,
        p_code: inputs[0].value,
        p_name: inputs[1].value,
        price: inputs[2].value,
        qty: inputs[3].value
      });
    });

    const btn = document.getElementById('saveBtn');
    btn.disabled = true; btn.innerText = 'ä¿å­˜ä¸­...';

    google.script.run
      .withSuccessHandler(msg => {
        alert(msg);
        btn.disabled = false; btn.innerText = 'ğŸ’¾ ä¿å­˜';
        loadData();
      })
      .withFailureHandler(e => {
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message);
        btn.disabled = false; btn.innerText = 'ğŸ’¾ ä¿å­˜';
      })
      .updateOrderData(updates);
  }

  // --- 6. ãã®ä»–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
  function toggleAllFiles(source) {
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = source.checked);
  }

  function exportSelectedFiles() {
    const checked = document.querySelectorAll('.file-checkbox:checked');
    if (!checked.length) return alert('å‡ºåŠ›ã—ãŸã„ç™ºæ³¨æ›¸ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');
    
    const targetFileIds = Array.from(checked).map(cb => cb.value).filter(val => val !== "");
    const targetKeys = rawData
      .filter(row => targetFileIds.includes(row.fileId))
      .map(row => row.uniqueKey);

    if (!targetKeys.length) return alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

    // è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const msg = `é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’Excelå‡ºåŠ›ã—ã¾ã™ã‹ï¼Ÿ\n\nã€é‡è¦ã€‘å‡ºåŠ›å¾Œã€é¸æŠã—ãŸç™ºæ³¨æ›¸ã¯è‡ªå‹•çš„ã«ã€Œå®Œäº†ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ãªã‚Šã€ã‚¢ãƒ—ãƒªå†…ã§ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™ã€‚\nï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿æŒã•ã‚Œã¾ã™ï¼‰`;
    if (!confirm(msg)) return;

    google.script.run
      .withSuccessHandler(url => {
        window.open(url, '_blank');
        document.getElementById('selectAllFiles').checked = false;
        setTimeout(() => loadData(), 500);  // å†èª­ã¿è¾¼ã¿ã§å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒéè¡¨ç¤ºã«
      })
      .withFailureHandler(e => alert('å‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ' + e.message))
      .exportSelectedDataToExcel(targetKeys, true);
  }

  function archiveSelectedFiles() {
    const checked = document.querySelectorAll('.file-checkbox:checked');
    if (!checked.length) return alert('å®Œäº†ã«ã—ãŸã„ç™ºæ³¨æ›¸ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„');

    const targetFileIds = Array.from(checked)
      .map(cb => cb.value)
      .filter(val => val !== "" && val !== "unknown");

    if (!targetFileIds.length) return alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

    const count = targetFileIds.length;
    if (!confirm(`${count}ä»¶ã®ç™ºæ³¨æ›¸ã‚’ã€Œå®Œäº†ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã—ã¾ã™ã€‚\n\nã‚¢ãƒ—ãƒªå†…ã§ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿æŒã•ã‚Œã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

    google.script.run
      .withSuccessHandler(result => {
        alert(result.message);
        document.getElementById('selectAllFiles').checked = false;
        loadData();  // å†èª­ã¿è¾¼ã¿ã§å®Œäº†ãƒ‡ãƒ¼ã‚¿ãŒéè¡¨ç¤ºã«ãªã‚‹
      })
      .withFailureHandler(e => alert('ã‚¨ãƒ©ãƒ¼: ' + e.message))
      .archiveOrdersByFileIds(targetFileIds);
  }

  function triggerManualProcess() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true; 
    btn.innerHTML = '<span>â³</span> å‡¦ç†ä¸­...';
    
    google.script.run
      .withSuccessHandler(msg => {
        alert(msg);
        btn.disabled = false; 
        btn.innerHTML = '<span>â†»</span> è‡ªå‹•å–è¾¼å®Ÿè¡Œ';
        loadData();
      })
      .withFailureHandler(e => {
        alert('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + e.message);
        btn.disabled = false; 
        btn.innerHTML = '<span>â†»</span> è‡ªå‹•å–è¾¼å®Ÿè¡Œ';
      })
      .runManualProcess();
  }
</script>
</body>
</html>